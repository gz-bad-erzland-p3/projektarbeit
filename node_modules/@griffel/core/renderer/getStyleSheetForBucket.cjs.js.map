{"version":3,"file":"getStyleSheetForBucket.cjs.js","sources":["../../../../packages/core/src/renderer/getStyleSheetForBucket.ts"],"sourcesContent":["import { DATA_BUCKET_ATTR } from '../constants';\nimport { GriffelRenderer, IsomorphicStyleSheet, StyleBucketName } from '../types';\nimport { createIsomorphicStyleSheet } from './createIsomorphicStyleSheet';\n\n/**\n * Ordered style buckets using their short pseudo name.\n *\n * @internal\n */\nexport const styleBucketOrdering: StyleBucketName[] = [\n  // reset styles\n  'r',\n  // catch-all\n  'd',\n  // link\n  'l',\n  // visited\n  'v',\n  // focus-within\n  'w',\n  // focus\n  'f',\n  // focus-visible\n  'i',\n  // hover\n  'h',\n  // active\n  'a',\n  // keyframes\n  'k',\n  // at-rules\n  't',\n  // @media rules\n  'm',\n];\n\n// avoid repeatedly calling `indexOf`to determine order during new insertions\nconst styleBucketOrderingMap = styleBucketOrdering.reduce((acc, cur, j) => {\n  acc[cur as StyleBucketName] = j;\n  return acc;\n}, {} as Record<StyleBucketName, number>);\n\n/**\n * Lazily adds a `<style>` bucket to the `<head>`. This will ensure that the style buckets are ordered.\n */\nexport function getStyleSheetForBucket(\n  bucketName: StyleBucketName,\n  target: Document | undefined,\n  renderer: GriffelRenderer,\n  elementAttributes: Record<string, string> = {},\n  metadata?: Record<string, unknown>,\n): IsomorphicStyleSheet {\n  let stylesheetKey: StyleBucketName | string = bucketName;\n\n  if (bucketName === 'm' && metadata) {\n    stylesheetKey = (bucketName + metadata['m']) as string;\n  }\n\n  if (!renderer.stylesheets[stylesheetKey]) {\n    const tag: HTMLStyleElement | undefined = target && target.createElement('style');\n\n    if (bucketName === 'm' && metadata) {\n      elementAttributes['media'] = metadata['m'] as string;\n    }\n\n    const stylesheet = createIsomorphicStyleSheet(tag, bucketName, elementAttributes);\n    renderer.stylesheets[stylesheetKey] = stylesheet;\n\n    if (target && tag) {\n      const elementSibling = findElementSibling(target, bucketName, renderer, metadata);\n      target.head.insertBefore(tag, elementSibling);\n    }\n  }\n\n  return renderer.stylesheets[stylesheetKey]!;\n}\n\n/**\n * Finds an element before which the new bucket style element should be inserted following the\n * bucket sort order\n *\n * @param target - document\n * @param targetBucket - The bucket that should be inserted to DOM\n * @param renderer - Griffel renderer\n * @param metadata - metadata for CSS rule\n * @returns - Smallest style element with greater sort order than the current bucket\n */\nfunction findElementSibling(\n  target: Document,\n  targetBucket: StyleBucketName,\n  renderer: GriffelRenderer,\n  metadata?: Record<string, unknown>,\n) {\n  const targetOrder = styleBucketOrderingMap[targetBucket];\n\n  // Similar to javascript sort comparators where\n  // a positive value is increasing sort order\n  // a negative value is decreasing sort order\n  let comparer: (el: HTMLStyleElement) => number = (el: HTMLStyleElement) =>\n    targetOrder - styleBucketOrderingMap[el.getAttribute(DATA_BUCKET_ATTR) as StyleBucketName];\n\n  let styleElements = target.head.querySelectorAll<HTMLStyleElement>(`[${DATA_BUCKET_ATTR}]`);\n\n  if (targetBucket === 'm' && metadata) {\n    const mediaElements = target.head.querySelectorAll<HTMLStyleElement>(`[${DATA_BUCKET_ATTR}=\"${targetBucket}\"]`);\n    // only reduce the scope of the search and change comparer\n    // if there are other media buckets already on the page\n    if (mediaElements.length) {\n      styleElements = mediaElements;\n      comparer = (el: HTMLStyleElement) => renderer.compareMediaQueries(metadata['m'] as string, el.media);\n    }\n  }\n\n  for (const styleElement of styleElements) {\n    if (comparer(styleElement) < 0) {\n      return styleElement;\n    }\n  }\n\n  return null;\n}\n"],"names":["styleBucketOrdering","styleBucketOrderingMap","reduce","acc","cur","j","getStyleSheetForBucket","bucketName","target","renderer","elementAttributes","metadata","stylesheetKey","stylesheets","tag","createElement","stylesheet","createIsomorphicStyleSheet","elementSibling","findElementSibling","head","insertBefore","targetBucket","targetOrder","comparer","el","getAttribute","DATA_BUCKET_ATTR","styleElements","querySelectorAll","mediaElements","length","compareMediaQueries","media","styleElement"],"mappings":";;;;;;;AAIA;;;;;;MAKaA,mBAAmB,GAAsB;AAEpD,GAFoD;AAIpD,GAJoD;AAMpD,GANoD;AAQpD,GARoD;AAUpD,GAVoD;AAYpD,GAZoD;AAcpD,GAdoD;AAgBpD,GAhBoD;AAkBpD,GAlBoD;AAoBpD,GApBoD;AAsBpD,GAtBoD;AAwBpD,GAxBoD;;AA4BtD,MAAMC,sBAAsB,gBAAGD,mBAAmB,CAACE,MAApB,CAA2B,CAACC,GAAD,EAAMC,GAAN,EAAWC,CAAX;EACxDF,GAAG,CAACC,GAAD,CAAH,GAA8BC,CAA9B;EACA,OAAOF,GAAP;AACD,CAH8B,EAG5B,EAH4B,CAA/B;AAKA;;;;SAGgBG,uBACdC,YACAC,QACAC,UACAC,oBAA4C,IAC5CC;EAEA,IAAIC,aAAa,GAA6BL,UAA9C;;EAEA,IAAIA,UAAU,KAAK,GAAf,IAAsBI,QAA1B,EAAoC;IAClCC,aAAa,GAAIL,UAAU,GAAGI,QAAQ,CAAC,GAAD,CAAtC;;;EAGF,IAAI,CAACF,QAAQ,CAACI,WAAT,CAAqBD,aAArB,CAAL,EAA0C;IACxC,MAAME,GAAG,GAAiCN,MAAM,IAAIA,MAAM,CAACO,aAAP,CAAqB,OAArB,CAApD;;IAEA,IAAIR,UAAU,KAAK,GAAf,IAAsBI,QAA1B,EAAoC;MAClCD,iBAAiB,CAAC,OAAD,CAAjB,GAA6BC,QAAQ,CAAC,GAAD,CAArC;;;IAGF,MAAMK,UAAU,GAAGC,qDAA0B,CAACH,GAAD,EAAMP,UAAN,EAAkBG,iBAAlB,CAA7C;IACAD,QAAQ,CAACI,WAAT,CAAqBD,aAArB,IAAsCI,UAAtC;;IAEA,IAAIR,MAAM,IAAIM,GAAd,EAAmB;MACjB,MAAMI,cAAc,GAAGC,kBAAkB,CAACX,MAAD,EAASD,UAAT,EAAqBE,QAArB,EAA+BE,QAA/B,CAAzC;MACAH,MAAM,CAACY,IAAP,CAAYC,YAAZ,CAAyBP,GAAzB,EAA8BI,cAA9B;;;;EAIJ,OAAOT,QAAQ,CAACI,WAAT,CAAqBD,aAArB,CAAP;AACD;AAED;;;;;;;;;;;AAUA,SAASO,kBAAT,CACEX,MADF,EAEEc,YAFF,EAGEb,QAHF,EAIEE,QAJF;EAME,MAAMY,WAAW,GAAGtB,sBAAsB,CAACqB,YAAD,CAA1C;;;;EAKA,IAAIE,QAAQ,GAAsCC,EAAD,IAC/CF,WAAW,GAAGtB,sBAAsB,CAACwB,EAAE,CAACC,YAAH,CAAgBC,0BAAhB,CAAD,CADtC;;EAGA,IAAIC,aAAa,GAAGpB,MAAM,CAACY,IAAP,CAAYS,gBAAZ,KAAmDF,6BAAnD,CAApB;;EAEA,IAAIL,YAAY,KAAK,GAAjB,IAAwBX,QAA5B,EAAsC;IACpC,MAAMmB,aAAa,GAAGtB,MAAM,CAACY,IAAP,CAAYS,gBAAZ,KAAmDF,+BAAqBL,gBAAxE,CAAtB,CADoC;;;IAIpC,IAAIQ,aAAa,CAACC,MAAlB,EAA0B;MACxBH,aAAa,GAAGE,aAAhB;;MACAN,QAAQ,GAAIC,EAAD,IAA0BhB,QAAQ,CAACuB,mBAAT,CAA6BrB,QAAQ,CAAC,GAAD,CAArC,EAAsDc,EAAE,CAACQ,KAAzD,CAArC;;;;EAIJ,KAAK,MAAMC,YAAX,IAA2BN,aAA3B,EAA0C;IACxC,IAAIJ,QAAQ,CAACU,YAAD,CAAR,GAAyB,CAA7B,EAAgC;MAC9B,OAAOA,YAAP;;;;EAIJ,OAAO,IAAP;AACD;;;;;"}
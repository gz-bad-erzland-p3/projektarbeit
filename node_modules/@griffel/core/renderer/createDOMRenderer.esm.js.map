{"version":3,"file":"createDOMRenderer.esm.js","sources":["../../../../packages/core/src/renderer/createDOMRenderer.ts"],"sourcesContent":["import { injectDevTools, isDevToolsEnabled, debugData } from '../devtools';\nimport { normalizeCSSBucketEntry } from '../runtime/utils/normalizeCSSBucketEntry';\nimport { GriffelRenderer, StyleBucketName } from '../types';\nimport { getStyleSheetForBucket } from './getStyleSheetForBucket';\n\nlet lastIndex = 0;\n\nexport interface CreateDOMRendererOptions {\n  /**\n   * A map of attributes that's passed to the generated style elements. Is useful to set \"nonce\" attribute.\n   *\n   * @see https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/nonce\n   */\n  styleElementAttributes?: Record<string, string>;\n\n  /**\n   * A filter run before CSS rule insertion to systematically remove CSS rules at render time.\n   * This can be used to forbid specific rules from being written to the style sheet at run time without\n   * affecting build time styles.\n   *\n   * ⚠️ Keep the filter as performant as possible to avoid negative performance impacts to your application.\n   * ⚠️ This API is unstable and can be removed from the library at any time.\n   */\n  unstable_filterCSSRule?: (cssRule: string) => boolean;\n\n  /**\n   * @param a - media query\n   * @param b - media query\n   * @returns positive number if a > b or negative number if a < b\n   */\n  compareMediaQueries?: (a: string, b: string) => number;\n}\n\n/** @internal */\nexport const defaultCompareMediaQueries = (a: string, b: string) => (a < b ? -1 : a > b ? 1 : 0);\n\n/**\n * Creates a new instances of a renderer.\n *\n * @public\n */\nexport function createDOMRenderer(\n  target: Document | undefined = typeof document === 'undefined' ? undefined : document,\n  options: CreateDOMRendererOptions = {},\n): GriffelRenderer {\n  const { unstable_filterCSSRule, compareMediaQueries = defaultCompareMediaQueries } = options;\n  const renderer: GriffelRenderer = {\n    insertionCache: {},\n    stylesheets: {},\n    compareMediaQueries,\n\n    id: `d${lastIndex++}`,\n\n    insertCSSRules(cssRules) {\n      // eslint-disable-next-line guard-for-in\n      for (const styleBucketName in cssRules) {\n        const cssRulesForBucket = cssRules[styleBucketName as StyleBucketName]!;\n\n        // This is a hot path in rendering styles: \".length\" is cached in \"l\" var to avoid accesses the property\n        for (let i = 0, l = cssRulesForBucket.length; i < l; i++) {\n          const [ruleCSS, metadata] = normalizeCSSBucketEntry(cssRulesForBucket[i]);\n          const sheet = getStyleSheetForBucket(\n            styleBucketName as StyleBucketName,\n            target,\n            renderer,\n            options.styleElementAttributes,\n            metadata,\n          );\n\n          if (renderer.insertionCache[ruleCSS]) {\n            continue;\n          }\n\n          renderer.insertionCache[ruleCSS] = styleBucketName as StyleBucketName;\n          if (process.env.NODE_ENV !== 'production' && isDevToolsEnabled) {\n            debugData.addCSSRule(ruleCSS);\n          }\n\n          try {\n            if (unstable_filterCSSRule) {\n              if (unstable_filterCSSRule(ruleCSS)) {\n                sheet.insertRule(ruleCSS);\n              }\n            } else {\n              sheet.insertRule(ruleCSS);\n            }\n          } catch (e) {\n            // We've disabled these warnings due to false-positive errors with browser prefixes\n            if (process.env.NODE_ENV !== 'production' && !ignoreSuffixesRegex.test(ruleCSS)) {\n              // eslint-disable-next-line no-console\n              console.error(`There was a problem inserting the following rule: \"${ruleCSS}\"`, e);\n            }\n          }\n        }\n      }\n    },\n  };\n\n  if (target && process.env.NODE_ENV !== 'production' && isDevToolsEnabled) {\n    injectDevTools(target);\n  }\n\n  return renderer;\n}\n\n/**\n * Suffixes to be ignored in case of error\n */\nconst ignoreSuffixes = [\n  '-moz-placeholder',\n  '-moz-focus-inner',\n  '-moz-focusring',\n  '-ms-input-placeholder',\n  '-moz-read-write',\n  '-moz-read-only',\n].join('|');\nconst ignoreSuffixesRegex = new RegExp(`:(${ignoreSuffixes})`);\n"],"names":["lastIndex","defaultCompareMediaQueries","a","b","createDOMRenderer","target","document","undefined","options","unstable_filterCSSRule","compareMediaQueries","renderer","insertionCache","stylesheets","id","insertCSSRules","cssRules","styleBucketName","cssRulesForBucket","i","l","length","ruleCSS","metadata","normalizeCSSBucketEntry","sheet","getStyleSheetForBucket","styleElementAttributes","process","env","NODE_ENV","isDevToolsEnabled","debugData","addCSSRule","insertRule","e","ignoreSuffixesRegex","test","console","error","injectDevTools","ignoreSuffixes","join","RegExp"],"mappings":";;;;;;AAKA,IAAIA,SAAS,GAAG,CAAhB;AA4BA;;MACaC,0BAA0B,GAAG,CAACC,CAAD,EAAYC,CAAZ,KAA2BD,CAAC,GAAGC,CAAJ,GAAQ,CAAC,CAAT,GAAaD,CAAC,GAAGC,CAAJ,GAAQ,CAAR,GAAY;AAE9F;;;;;;SAKgBC,kBACdC,SAA+B,OAAOC,QAAP,KAAoB,WAApB,GAAkCC,SAAlC,GAA8CD,UAC7EE,UAAoC;EAEpC,MAAM;IAAEC,sBAAF;IAA0BC,mBAAmB,GAAGT;MAA+BO,OAArF;EACA,MAAMG,QAAQ,GAAoB;IAChCC,cAAc,EAAE,EADgB;IAEhCC,WAAW,EAAE,EAFmB;IAGhCH,mBAHgC;IAKhCI,EAAE,MAAMd,SAAS,IALe;;IAOhCe,cAAc,CAACC,QAAD;;MAEZ,KAAK,MAAMC,eAAX,IAA8BD,QAA9B,EAAwC;QACtC,MAAME,iBAAiB,GAAGF,QAAQ,CAACC,eAAD,CAAlC,CADsC;;QAItC,KAAK,IAAIE,CAAC,GAAG,CAAR,EAAWC,CAAC,GAAGF,iBAAiB,CAACG,MAAtC,EAA8CF,CAAC,GAAGC,CAAlD,EAAqDD,CAAC,EAAtD,EAA0D;UACxD,MAAM,CAACG,OAAD,EAAUC,QAAV,IAAsBC,uBAAuB,CAACN,iBAAiB,CAACC,CAAD,CAAlB,CAAnD;UACA,MAAMM,KAAK,GAAGC,sBAAsB,CAClCT,eADkC,EAElCZ,MAFkC,EAGlCM,QAHkC,EAIlCH,OAAO,CAACmB,sBAJ0B,EAKlCJ,QALkC,CAApC;;UAQA,IAAIZ,QAAQ,CAACC,cAAT,CAAwBU,OAAxB,CAAJ,EAAsC;YACpC;;;UAGFX,QAAQ,CAACC,cAAT,CAAwBU,OAAxB,IAAmCL,eAAnC;;UACA,IAAIW,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,YAAzB,IAAyCC,iBAA7C,EAAgE;YAC9DC,SAAS,CAACC,UAAV,CAAqBX,OAArB;;;UAGF,IAAI;YACF,IAAIb,sBAAJ,EAA4B;cAC1B,IAAIA,sBAAsB,CAACa,OAAD,CAA1B,EAAqC;gBACnCG,KAAK,CAACS,UAAN,CAAiBZ,OAAjB;;aAFJ,MAIO;cACLG,KAAK,CAACS,UAAN,CAAiBZ,OAAjB;;WANJ,CAQE,OAAOa,CAAP,EAAU;;YAEV,IAAIP,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,YAAzB,IAAyC,CAACM,mBAAmB,CAACC,IAApB,CAAyBf,OAAzB,CAA9C,EAAiF;;cAE/EgB,OAAO,CAACC,KAAR,uDAAoEjB,UAApE,EAAgFa,CAAhF;;;;;;;GA5CZ;;EAoDA,IAAI9B,MAAM,IAAIuB,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,YAAnC,IAAmDC,iBAAvD,EAA0E;IACxES,cAAc,CAACnC,MAAD,CAAd;;;EAGF,OAAOM,QAAP;AACD;AAED;;;;AAGA,MAAM8B,cAAc,gBAAG,CACrB,kBADqB,EAErB,kBAFqB,EAGrB,gBAHqB,EAIrB,uBAJqB,EAKrB,iBALqB,EAMrB,gBANqB,EAOrBC,IAPqB,CAOhB,GAPgB,CAAvB;AAQA,MAAMN,mBAAmB,gBAAG,IAAIO,MAAJ,MAAgBF,iBAAhB,CAA5B;;;;"}